{% extends 'base.html' %}

{% block title %}{{ project.name }} — Freelance CRM{% endblock %}

{% block extra_css %}
<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }

    html, body {
        height: 100%;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="h-[calc(100vh-120px)] flex flex-col w-full px-4">
    <div class="flex justify-between items-center py-4">
        <h1 class="text-2xl font-bold text-gray-900">{{ project.name }}</h1>
        <div class="flex gap-3">
            <a href="{% url 'projects:update' project.pk %}"
               class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition text-sm font-medium">Редактировать</a>
            <form action="{% url 'projects:delete' project.pk %}" method="post" class="inline">
                {% csrf_token %}
                <button type="submit" onclick="return confirm('Удалить проект?');"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition text-sm font-medium">
                    Удалить
                </button>
            </form>
        </div>
    </div>

    <div class="flex flex-1 border rounded-xl overflow-hidden bg-white shadow-sm min-h-0 mb-4">
        <aside class="w-1/4 min-w-[280px] bg-gray-50 border-r border-gray-200 flex flex-col">
            <div class="p-6 overflow-y-auto custom-scrollbar flex-1">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Клиент</h3>
                        <p class="mt-1 text-sm font-bold text-gray-900">{{ project.client }}</p>
                    </div>
                    <div class="flex justify-between">
                        <div>
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest text-left">
                                Статус</h3>
                            <p class="mt-1 text-sm font-bold text-gray-900">{{ project.get_status_display }}</p>
                        </div>
                        <div class="text-right">
                            <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Бюджет</h3>
                            <p class="mt-1 text-sm font-bold text-blue-600">{{ project.budget|default:"0" }} ₽</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Дедлайн</h3>
                        <p class="mt-1 text-sm font-bold {% if project.is_overdue %}text-red-600{% else %}text-gray-900{% endif %}">
                            {{ project.deadline|date:"d.m.Y"|default:"—"}}
                        </p>
                    </div>
                    <div class="pt-4 border-t border-gray-200">
                        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Описание</h3>
                        <p class="text-sm text-gray-600 leading-relaxed whitespace-pre-wrap">
                            {{project.description|default:"Нет описания" }}</p>
                    </div>
                </div>
            </div>
            <div class="px-16 py-1 flex border-t border-gray-200 justify-center items-center bg-gray-50">
                <a href="{% url 'projects:list' %}"
                   class="w-full text-center bg-blue-400 text-white py-2 px-4 rounded-lg hover:bg-blue-600 transition text-xs font-bold uppercase tracking-tighter shadow-sm">
                    ← К списку проектов
                </a>
            </div>
        </aside>

        <main class="w-3/4 flex flex-col min-w-0">
            <section class="flex-1 flex flex-col min-h-0 border-b border-gray-100">
                <div class="px-6 py-4 flex justify-between items-center bg-white">
                    <h2 class="text-xs font-black text-gray-800 uppercase tracking-widest">Задачи проекта</h2>
                    <a href="{% url 'tasks:create' project.pk %}"
                       class="text-[10px] bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition">+
                        Добавить задачу</a>
                </div>
                <div class="flex-1 overflow-y-auto custom-scrollbar px-6">
                    <table class="min-w-full text-sm">
                        <thead class="bg-white sticky top-0 border-b z-10">
                        <tr class="text-[10px] text-gray-600 uppercase tracking-tighter">
                            <th class="py-2 text-left font-semibold">Название задачи</th>
                            <th class="py-2 text-center font-semibold">Статус</th>
                            <th class="py-2 text-right font-semibold">Дедлайн</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50">
                        {% for task in page_obj %}
                        <tr class="hover:bg-indigo-50/50 transition cursor-pointer"
                            onclick="window.location='{% url 'tasks:update' task.pk %}'">
                            <td class="py-3 font-medium text-gray-700">{{ task.title }}</td>
                            <td class="py-3 text-center">
                                <span class="text-[9px] px-2 py-0.5 rounded font-bold border {% if task.status == 'done' %}
                                bg-green-50 text-green-600 border-green-200{% else %}bg-gray-50 text-gray-500 border-gray-200{% endif %}">
                                    {{ task.get_status_display }}
                                </span>
                            </td>
                            <td class="py-3 text-right">
                                <div class="flex flex-col items-end">
                                    <span class="text-[11px] font-mono {% if task.status != 'done' and task.deadline < today %}
                                    text-red-600 font-bold{% else %}text-gray-400{% endif %}">
                                        {{ task.deadline|date:"d.m.Y"|default:"—" }}
                                    </span>
                                    {% if task.status != 'done' and task.deadline < today %}
                                    <span class="text-[9px] text-red-500 font-bold uppercase tracking-tighter leading-none mt-0.5">
                                            [Просрочено]
                                        </span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if page_obj.has_other_pages %}
                <div class="px-6 py-2 border-t bg-gray-50 flex justify-center gap-2">
                    {% if page_obj.has_previous %}<a href="?task_page={{ page_obj.previous_page_number }}"
                                                     class="text-[10px] font-bold text-indigo-600">Назад</a>{% endif %}
                    <span class="text-[10px] text-gray-400">Стр {{ page_obj.number }}</span>
                    {% if page_obj.has_next %}<a href="?task_page={{ page_obj.next_page_number }}"
                                                 class="text-[10px] font-bold text-indigo-600">Вперед</a>{% endif %}
                </div>
                {% endif %}
            </section>

            <section class="flex-1 flex flex-col min-h-0 bg-gray-50/20">
                <div class="px-6 py-4 flex justify-between items-center bg-white/50 backdrop-blur-sm border-b border-gray-100 shrink-0">
                    <h2 class="text-xs font-black text-gray-800 uppercase tracking-widest">Счета проекта</h2>
                    <a href="{% url 'invoices:create_from_project' project.pk %}"
                       class="text-[10px] bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600 transition shadow-sm">
                        Создать счёт
                    </a>
                </div>

                <div class="flex-1 overflow-y-auto custom-scrollbar px-6">
                    <table class="min-w-full text-sm">
                        <thead class="sticky top-0 z-10 bg-white border-b">
                        <tr class="text-[10px] text-gray-500 uppercase tracking-tighter">
                            <th class="py-3 px-4 text-left font-semibold">№ Счёта</th>
                            <th class="py-3 px-4 text-left font-semibold">Сумма</th>
                            <th class="py-3 px-4 text-center font-semibold">Статус</th>
                            <th class="py-3 px-4 text-right font-semibold">Действия</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                        {% for invoice in invoices %}
                        <tr class="hover:bg-gray-50/80 transition cursor-pointer group"
                            onclick="window.location='{% url 'invoices:update' invoice.pk %}'">
                            <td class="py-4 px-4 font-mono text-indigo-600 font-semibold group-hover:text-indigo-800">
                                <a href="{% url 'invoices:update' invoice.pk %}" class="hover:underline">
                                    {{ invoice.number }}
                                </a>
                            </td>
                            <td class="py-4 px-4 font-bold text-gray-900">
                                {{ invoice.amount|floatformat:2 }} ₽
                            </td>
                            <td class="py-4 px-4 text-center">
                                {% if invoice.status == 'draft' %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700 border border-gray-300">
                        <span class="w-2 h-2 rounded-full bg-gray-500"></span>
                        Черновик
                    </span>
                                {% elif invoice.status == 'sent' %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 border border-blue-300">
                        <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                        Отправлен
                    </span>
                                {% elif invoice.status == 'partially_paid' %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-300">
                        <span class="w-2 h-2 rounded-full bg-yellow-500"></span>
                        Частично оплачен
                    </span>
                                {% elif invoice.status == 'paid' %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-700 border border-green-300">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd"
                                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                  clip-rule="evenodd"/>
                        </svg>
                        Оплачен
                    </span>
                                {% elif invoice.status == 'overdue' %}
                                <span class="inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold bg-red-100 text-red-700 border border-red-300 animate-pulse">
                        <span class="text-red-600 font-black">!</span>
                        Просрочен
                    </span>
                                {% else %}
                                <span class="text-gray-500 text-xs">{{ invoice.get_status_display }}</span>
                                {% endif %}
                            </td>
                            <td class="py-4 px-4 text-right" onclick="event.stopPropagation()">
                                <div class="flex justify-end gap-4 items-center">
                                    <!-- PDF -->
                                    <a href="{% url 'invoices:pdf' invoice.pk %}"
                                       class="text-indigo-600 hover:text-indigo-800 transition flex items-center gap-1 group"
                                       title="Скачать PDF">
                                        <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none"
                                             viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                        <span class="text-[10px] font-bold hidden group-hover:inline">PDF</span>
                                    </a>

                                    <!-- Telegram -->
                                    {% if invoice.project.client.telegram_chat_id %}
                                    <button onclick="sendToTelegram(event, {{ invoice.pk }})"
                                            title="Отправить клиенту в Telegram"
                                            class="flex items-center justify-center w-7 h-7 transition-all hover:scale-110 active:scale-95 rounded-full hover:bg-sky-50 focus:outline-none">

                                        <svg class="w-5 h-5" viewBox="0 0 240 240" fill="none"
                                             xmlns="http://www.w3.org/2000/svg">
                                            <circle id="tg-circle-{{ invoice.pk }}"
                                                    cx="120" cy="120" r="120"
                                                    fill="#38b0e3"
                                                    style="transition: fill 0.5s ease;"/>

                                            <path d="M54.3,118.8c35-15.2,58.3-25.3,70-30.2 c33.3-13.9,40.3-16.3,44.8-16.4c1,0,3.2,0.2,4.7,1.4c1.2,1,1.5,2.3,1.7,3.3s0.4,3.1,0.2,4.7c-1.8,19-9.6,65.1-13.6,86.3 c-1.7,9-5,12-8.2,12.3c-7,0.6-12.3-4.6-19-9c-10.6-6.9-16.5-11.2-26.8-18c-11.9-7.8-4.2-12.1,2.6-19.1c1.8-1.8,32.5-29.8,33.1-32.3 c0.1-0.3,0.1-1.5-0.6-2.1c-0.7-0.6-1.7-0.4-2.5-0.2c-1.1,0.2-17.9,11.4-50.6,33.5c-4.8,3.3-9.1,4.9-13,4.8 c-4.3-0.1-12.5-2.4-18.7-4.4c-7.5-2.4-13.5-3.7-13-7.9C45.7,123.3,48.7,121.1,54.3,118.8z"
                                                  fill="white"/>
                                        </svg>
                                    </button>
                                    {% else %}
                                    <span class="text-gray-400 text-[10px]" title="У клиента нет Telegram">Нет TG</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if invoices.has_other_pages %}
                <div class="px-6 py-2 border-t bg-white shrink-0 flex justify-center gap-2">
                    {% if invoices.has_previous %}<a href="?invoice_page={{ invoices.previous_page_number }}"
                                                     class="text-[10px] font-bold text-indigo-600">Назад</a>{% endif %}
                    <span class="text-[10px] text-gray-400">Стр {{ invoices.number }}</span>
                    {% if invoices.has_next %}<a href="?invoice_page={{ invoices.next_page_number }}"
                                                 class="text-[10px] font-bold text-indigo-600">Вперед</a>{% endif %}
                </div>
                {% endif %}
            </section>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. Save the position BEFORE leaving the page
    document.addEventListener('click', function (e) {
        const link = e.target.closest('nav a');
        // We check that the click was on the pagination (tasks or invoices)
        if (link && (link.href.includes('task_page') || link.href.includes('invoice_page'))) {
            localStorage.setItem('scrollPosition', window.scrollY);
        }
    });

    // 2. Restore the position after loading the content
    window.addEventListener('load', function () {
        const scrollPosition = localStorage.getItem('scrollPosition');

        if (scrollPosition) {
            // Use requestAnimationFrame or setTimeout to give the browser time to render the table.
            requestAnimationFrame(() => {
                window.scrollTo({
                    top: parseInt(scrollPosition),
                    behavior: 'instant'
                });
                localStorage.removeItem('scrollPosition');
            });
        }
    });

    function sendToTelegram(e, invoiceId) {
        e.stopPropagation();
        const circle = document.getElementById(`tg-circle-${invoiceId}`);
        const originalColor = "#38b0e3";

        circle.style.opacity = "0.5";

        fetch(`/invoices/${invoiceId}/send-telegram/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
            .then(r => r.json())
            .then(data => {
                circle.style.opacity = "1";

                // Проверяем и статус, и текст сообщения одновременно
                const isSuccess = data.status === 'success' ||
                    (data.message && data.message.toLowerCase().includes('успешно'));

                if (isSuccess) {
                    circle.setAttribute('fill', '#22c55e'); // Зеленый
                } else {
                    circle.setAttribute('fill', '#ef4444'); // Красный
                    console.error("Сервер ответил ошибкой:", data.message);
                }

                setTimeout(() => circle.setAttribute('fill', originalColor), 1500);
            })
            .catch(err => {
                circle.style.opacity = "1";
                circle.setAttribute('fill', '#ef4444'); // Красный при сетевой ошибке
                setTimeout(() => circle.setAttribute('fill', originalColor), 2000);
            });
    }
</script>
{% endblock %}